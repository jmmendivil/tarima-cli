#!/usr/bin/env node

var start = new Date();

var run = require('./'),
    path = require('path'),
    minimist = require('minimist');

var $ = require('./utils');

var pwd = process.cwd(),
    pkg = path.join(pwd, 'package.json');

var argv = minimist(process.argv.slice(2), {
  boolean: ['force', 'watch'],
  string: ['only'],
  alias: {
    f: 'force',
    w: 'watch',
    i: 'only'
  }
});

var fixedSrc = argv._[0] || 'src',
    fixedDest = argv._[1] || 'build';

var defaultConfig = {
  src: path.join(pwd, fixedSrc),
  dest: path.join(pwd, fixedDest, 'dist'),
  cache: path.join(pwd, fixedDest, 'index.json'),
  force: argv.force,
  watch: argv.watch
};

if ($.isFile(pkg)) {
  $.merge(defaultConfig, $.readJSON(pkg).tarima || {});
}

if (argv.only) {
  if (!defaultConfig.filtered) {
    defaultConfig.filtered = [];
  }

  var test = !Array.isArray(argv.only) ? argv.only.split(/[,:|]/) : argv.only;

  defaultConfig.filtered.push(function(value) {
    for (var key in test) {
      if (value.indexOf(test[key]) > -1) {
        return true;
      }
    }
  });
}

run(defaultConfig, function(err, result) {
  if (err) {
    console.log($.style('{red|%s}', err.stack || err));
  }

  console.log($.style('{cyan|%s file(s) synced in %s}', result.files.length, $.timeDiff(start)));
});
